[tox]
envlist = py38,py39,py310,py311,lint,docs,security
isolated_build = True

[testenv]
deps = 
    .[test]
    pytest-benchmark
commands = 
    pytest {posargs}

[testenv:py38]
basepython = python3.8

[testenv:py39]
basepython = python3.9

[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:lint]
deps = 
    .[lint]
commands = 
    ruff check src tests
    black --check src tests
    mypy src

[testenv:format]
deps = 
    .[lint]
commands = 
    ruff check src tests --fix
    black src tests

[testenv:security]
deps = 
    bandit[toml]
    safety
commands = 
    bandit -r src -f json -o bandit-report.json
    safety check --json --output safety-report.json

[testenv:docs]
deps = 
    .[docs]
commands = 
    mkdocs build

[testenv:coverage]
deps = 
    .[test]
commands = 
    pytest --cov=src --cov-report=html --cov-report=term-missing

[testenv:benchmark]
deps = 
    .[test]
    pytest-benchmark
commands = 
    pytest tests/performance -m performance

[testenv:integration]
deps = 
    .[test]
commands = 
    pytest tests/integration -m integration

[testenv:e2e]
deps = 
    .[test]
commands = 
    pytest tests/e2e -m slow

[testenv:mutation]
deps = 
    .[test]
    mutmut==2.4.4
commands = 
    python scripts/run_mutation_tests.py

[testenv:contract]
deps = 
    .[test]
    pact-python==2.2.1
    pytest-html==4.1.1
commands = 
    ./scripts/run_contract_tests.sh --report

[testenv:load]
deps = 
    .[test]
    locust==2.31.8
    faker==30.3.0
    requests
commands = 
    python scripts/run_load_tests.py baseline

[testenv:quality]
deps = 
    .[lint]
    pylint==3.3.1
    requests
commands = 
    python quality_gates/sonar_runner.py --wait-for-quality-gate

[testenv:sbom]
deps = 
    requests
allowlist_externals = 
    syft
    grype
commands = 
    python sbom/generate_sbom.py

[testenv:clean]
deps = 
commands = 
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.pytest_cache', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('mutation_results', ignore_errors=True)"